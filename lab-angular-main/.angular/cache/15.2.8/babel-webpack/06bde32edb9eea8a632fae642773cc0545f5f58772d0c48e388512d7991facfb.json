{"ast":null,"code":"import { throwError } from 'rxjs';\nimport { map, switchMap, catchError } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/router\";\nexport class AuthService {\n  constructor(http, router) {\n    this.http = http;\n    this.router = router;\n    this.apiUrl = 'http://localhost:3000/users';\n    this.sessionStartTime = null;\n  }\n  checkDuplicateEmail(email) {\n    return this.http.get(this.apiUrl).pipe(map(users => ({\n      isDuplicate: users.some(user => user.email.toLowerCase() === email.toLowerCase()),\n      users\n    })), catchError(error => throwError(() => new Error('Server error while checking email.'))));\n  }\n  register(user) {\n    return this.checkDuplicateEmail(user.email).pipe(switchMap(({\n      isDuplicate,\n      users\n    }) => {\n      if (isDuplicate) {\n        return throwError(() => new Error('This email is already registered.'));\n      }\n      const adminCount = users.filter(u => u.role === 'admin').length;\n      if (user.role === 'admin' && adminCount < {\n        return: throwError(() => new Error('Only one admin is allowed.'))\n      }) return this.http.post(this.apiUrl, user);\n    }), catchError(error => throwError(() => new Error(error.message || 'Registration failed.'))));\n  }\n  login(email, password) {\n    return this.http.get(`${this.apiUrl}?email=${email}&password=${password}`).pipe(map(users => {\n      if (users.length > 0) {\n        const user = users[0];\n        user.activeTime = 0; // Reset active time on login\n        this.sessionStartTime = Date.now();\n        localStorage.setItem('user', JSON.stringify(user));\n        return user;\n      }\n      throw new Error('Invalid email or password');\n    }), catchError(error => throwError(() => new Error('Login failed.'))));\n  }\n  logout() {\n    if (this.sessionStartTime) {\n      const user = JSON.parse(localStorage.getItem('user') || '{}');\n      const activeTime = Math.floor((Date.now() - this.sessionStartTime) / 60000); // In minutes\n      user.activeTime = (user.activeTime || 0) + activeTime;\n      this.http.put(`${this.apiUrl}/${user.id}`, user).subscribe({\n        next: () => console.log('Active time updated on server'),\n        error: err => console.error('Failed to update active time:', err)\n      });\n      this.sessionStartTime = null;\n    }\n    localStorage.removeItem('user');\n  }\n  verifyAdminPin(pin) {\n    const user = JSON.parse(localStorage.getItem('user') || '{}');\n    if (user.role === 'admin') {\n      return pin === user.adminPin;\n    }\n    return false;\n  }\n  isLoggedIn() {\n    return !!localStorage.getItem('user');\n  }\n}\nAuthService.ɵfac = function AuthService_Factory(t) {\n  return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.Router));\n};\nAuthService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: AuthService,\n  factory: AuthService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["throwError","map","switchMap","catchError","AuthService","constructor","http","router","checkDuplicateEmail","email","get","apiUrl","pipe","users","isDuplicate","some","user","toLowerCase","error","Error","register","adminCount","filter","u","role","length","return","post","message","login","password","activeTime","sessionStartTime","Date","now","localStorage","setItem","JSON","stringify","logout","parse","getItem","Math","floor","put","id","subscribe","next","console","log","err","removeItem","verifyAdminPin","pin","adminPin","isLoggedIn","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\malik\\Downloads\\Evaluation\\lab-angular-main\\src\\app\\core\\auth.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable, throwError } from 'rxjs';\nimport { map, switchMap, catchError } from 'rxjs/operators';\nimport { Router } from '@angular/router';\nimport { User } from '../shared/models/user.model';\n\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class AuthService {\n  private apiUrl = 'http://localhost:3000/users';\n  private sessionStartTime: number | null = null;\n\n  constructor(private http: HttpClient, private router: Router) {}\n\n  checkDuplicateEmail(email: string): Observable<{ isDuplicate: boolean; users: User[] }> {\n    return this.http.get<User[]>(this.apiUrl).pipe(\n      map(users => ({ isDuplicate: users.some(user => user.email.toLowerCase() === email.toLowerCase()), users })),\n      catchError(error => throwError(() => new Error('Server error while checking email.')))\n    );\n  }\n\n  register(user: User): Observable<User> {\n    return this.checkDuplicateEmail(user.email).pipe(\n      switchMap(({ isDuplicate, users }) => {\n        if (isDuplicate) {\n          return throwError(() => new Error('This email is already registered.'));\n        }\n        const adminCount = users.filter(u => u.role === 'admin').length;\n        if (user.role === 'admin' && adminCount <  {\n          return throwError(() => new Error('Only one admin is allowed.'));\n        }\n        return this.http.post<User>(this.apiUrl, user);\n      }),\n      catchError(error => throwError(() => new Error(error.message || 'Registration failed.')))\n    );\n  }\n\n  login(email: string, password: string): Observable<User> {\n    return this.http.get<User[]>(`${this.apiUrl}?email=${email}&password=${password}`).pipe(\n      map(users => {\n        if (users.length > 0) {\n          const user = users[0];\n          user.activeTime = 0; // Reset active time on login\n          this.sessionStartTime = Date.now();\n          localStorage.setItem('user', JSON.stringify(user));\n          return user;\n        }\n        throw new Error('Invalid email or password');\n      }),\n      catchError(error => throwError(() => new Error('Login failed.')))\n    );\n  }\n\n  logout(): void {\n    if (this.sessionStartTime) {\n      const user = JSON.parse(localStorage.getItem('user') || '{}');\n      const activeTime = Math.floor((Date.now() - this.sessionStartTime) / 60000); // In minutes\n      user.activeTime = (user.activeTime || 0) + activeTime;\n      this.http.put<User>(`${this.apiUrl}/${user.id}`, user).subscribe({\n        next: () => console.log('Active time updated on server'),\n        error: (err: Error) => console.error('Failed to update active time:', err)\n      });\n      this.sessionStartTime = null;\n    }\n    localStorage.removeItem('user');\n  }\n\n  verifyAdminPin(pin: string): boolean {\n    const user = JSON.parse(localStorage.getItem('user') || '{}');\n    if (user.role === 'admin') {\n      return pin === user.adminPin;\n    }\n    return false;\n  }\n\n  isLoggedIn(): boolean {\n    return !!localStorage.getItem('user');\n  }\n}"]},"metadata":{},"sourceType":"module","externalDependencies":[]}